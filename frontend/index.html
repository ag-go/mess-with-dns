<html>

<head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title> mess with dns </title>
    <link rel="stylesheet" type="text/css" href="css/tailwind.min.css" />
    <link rel="stylesheet" type="text/css" href="css/squiggle.css" />
    <style>
        a {
            text-decoration: underline;
        }
        .formulate-input-error {
            color: red;
        }
        li {
            margin: .5em 0;
            list-style-type: decimal;
            /* numbers */
        }
        ol, ul {
            margin-left: 1em;
        }
    </style>
</head>

<body class="relative">
    <nav id="nav" class="py-8 squiggle-bottom bg-green-600 text-white" role="navigation">
        <div class="flex">
            <div class="m-auto">
                <h1 class="text-4xl">
                    ★ mess with dns ★
                </h1>
                <div class="text-right mt-2"> a <a class="underline py-2" href="https://wizardzines.com">wizard zines</a> project</div>
            </div>
        </div>
    </nav>



    <div class="flex" id="app" >
        <div id="sidebar" class="px-16 border-r-2 border-green-700 fixed overflow-scroll left-0 bg-white" style="height: 80vh">
            <div id="experiments"  style="max-width: 400px" v-if="sidebar">
                <div class="flex justify-center">
                </div>

                <h2 class="font-bold text-2xl text-left mb-8 mt-16">
                    Experiments where we break things for fun and learning:
                </h2>

                <details class="relative my-4 border border-green-700 p-6">
                    <summary>
                        <h3 class="font-bold text-xl text-left mb-8 my-8 inline">
                            1. Visit a domain before creating its record
                            <div style="top: -.8em; right: 2em;" class="px-1 absolute bg-white text-right text-green-700 text-sm">
                                caching
                            </div>
                        </h3>
                    </summary>

                    <p class="my-4">
                        If you visit a domain before setting your DNS records for
                        that domain, it still won't work for some time after
                        setting the record!
                        Here's an experiment you can do to see
                        that happen yourself:
                    </p>
                    <ol>
                        <li>
                            Go to <domain-link :domain='domain'> </domain-link>
                            in your browser. You should get an error like "Server Not Found".
                        </li>
                        <li>
                            Create a CNAME record pointing <domain-link :domain='domain'> </domain-link>
                            at <code>orange-ip.fly.dev</code>, like this:
                            <img src="/images/cname-screenshot.png" class="block border  border-dashed border-green-700 mb-4 mt-2">
                        </li>
                        <li>
                            Go to <domain-link :domain='domain'> </domain-link> in your browser again. You should get the same "Server Not Found" error as before.
                        </li>
                        <li>
                            Repeat this with a 
                            <a :href="'/#' + randomSubdomain()"> different random subdomain</a>,
                            but <span class="font-bold">don't</span> visit the domain first.
                        </li>
                    </ol>

                    <p class="my-4">
                    <details>
                        <summary>
                            <span class="text-green-700">
                                (click here to see the explanation)
                            </span>
                        </summary>
                        <p>
                            This is because of something called "negative DNS caching" -- DNS servers will cache the <strong>absence</strong> of a record.
                        </p>
                    </details>
                    </p>
                </details>

                <details class="relative my-8 border border-green-700 p-6">
                    <summary>
                        <h3 class="font-bold text-xl text-left mb-8 my-8 inline">
                            2. Test the difference between setting a short TTL and a long TTL
                            <div style="top: -.8em; right: 2em;" class="px-1 absolute bg-white text-right text-green-700 text-sm">
                                caching
                            </div>
                        </h3>
                    </summary>
                    <ol>
                        <li>
                            Create a CNAME record pointing <domain-link :domain='domain'> </domain-link>
                            at <code>orange-ip.fly.dev</code>.

                            Use a long TTL like 300000 seconds.
                            <!-- TODO: change screenshots -->
                            <img src="/images/cname-screenshot-5.png" class="block border border-dashed border-green-700 mb-4 mt-2">
                        </li>
                        <li>
                            Go to <domain-link :domain='domain'> </domain-link>
                            in your browser.
                        </li>
                        <li>
                            Change the CNAME record to point at <code>purple-ip.fly.dev</code> instead.
                            <img src="/images/cname-screenshot-metafilter.png" class="block border border-dashed border-green-700 mb-4 mt-2">
                        </li>
                        <li>
                            Go to <domain-link :domain='domain'> </domain-link>
                            in your browser again. You should see
                            the same orange site -- no change!
                            This is because your old DNS record is
                            still cached.
                        </li>
                        <li>
                            Using a 
                            <a :href="'/#' + randomSubdomain()"> different random subdomain</a>, repeat
                            the same experiment with a short TTL. You might
                            need to do a force reload (Ctrl+Shift+R or similar)
                            after changing the DNS record to point at the purple site.
                            This time, the change works! (Also, you can test what happens if you use the same subdomain!)
                        </li>
                    </ol>

                    <p class="my-4">
                    <details>
                        <summary>
                            <span class="text-green-700">
                                (click here to see the explanation)
                            </span>
                        </summary>
                        <p>
                            TODO: add explanation
                        </p>
                    </details>
                    </p>
                </details>

                <details class="relative my-8 border border-green-700 p-6">
                    <summary>
                        <h3 class="font-bold text-xl text-left mb-8 my-8 inline">
                            3. Convince 3 different DNS servers that your subdomain has 3 different IPs
                            <div style="top: -.8em; right: 2em;" class="px-1 absolute bg-white text-right text-green-700 text-sm">
                                caching
                            </div>
                        </h3>
                        </h3>

                        <p>
                            Let's create some confusion and chaos! This is usually a bad thing, but let's do it on purpose so that you can see how it could happen accidentally.
                            Here your goal is to convince
                        </p>
                        <ul>
                            <li>
                                Google's DNS server that your subdomain has one IP (10.11.12.13),
                            </li>
                            <li>
                                Cloudflare's DNS server that your subdomain has another IP (20.21.22.23),
                            </li>
                            <li>
                                Quad9's DNS server that your subdomain has a third IP (30.31.32.33),
                            </li>
                        </ul>

                        and have them all believe these conflicting things at the same time
                    </summary>
                </details>

                <details class="relative my-8 border border-green-700 p-6">
                    <summary>
                        <h3 class="font-bold text-xl text-left mb-8 my-8 inline">
                            4. Set two conflicting A records
                            <div style="top: -.8em; right: 2em;" class="px-1 absolute bg-white text-right text-green-700 text-sm">
                                A records
                            </div>
                        </h3>
                    </summary>

                    What if you set two A records on a domain that refer to totally different sites? Let's find out!
                            <ul>
                                <li> Set an A record pointing <domain-link :domain='domain'> </domain-link> at 
                                    213.188.218.160 with a TTL of 5 seconds.
                                </li>
                                <li> Set another A record pointing <domain-link :domain='domain'> </domain-link> at 
                                    213.188.209.192 with a TTL of 5 seconds.
                                </li>
                                <li>
                                    In your terminal, run 
                                    <pre>$ curl http://{{currDomain()}}.messwithdns.com</pre>
                                    10 times.
                                    The results I get when doing this are:
<pre>
$ curl http://{{currDomain()}}.messwithdns.com/ 2&gt; /dev/null | grep title
    &lt;title&gt;orange&lt;/title&gt;
$ curl http://{{currDomain()}}.messwithdns.com/ 2&gt; /dev/null | grep title
    &lt;title&gt;purple&lt;/title&gt;
$ curl http://{{currDomain()}}.messwithdns.com/ 2&gt; /dev/null | grep title
    &lt;title&gt;orange&lt;/title&gt;
$ curl http://{{currDomain()}}.messwithdns.com/ 2&gt; /dev/null | grep title
    &lt;title&gt;purple&lt;/title&gt;
$ curl http://{{currDomain()}}.messwithdns.com/ 2&gt; /dev/null | grep title
    &lt;title&gt;orange&lt;/title&gt;
$ curl http://{{currDomain()}}.messwithdns.com/ 2&gt; /dev/null | grep title
    &lt;title&gt;purple&lt;/title&gt;
$ curl http://{{currDomain()}}.messwithdns.com/ 2&gt; /dev/null | grep title
    &lt;title&gt;orange&lt;/title&gt;
$ curl http://{{currDomain()}}.messwithdns.com/ 2&gt; /dev/null | grep title
    &lt;title&gt;purple&lt;/title&gt;
</pre>
                                </li>
                </details>
                <h2 class="font-bold text-2xl text-left mb-8 mt-16">
                    Experiments with useful things you might actually want to do:
                </h2>
                <details class="relative my-8 border border-green-700 p-6">
                    <summary>
                        <h3 class="font-bold text-xl text-left mb-8 my-8 inline">
                            3. Query the source of truth
                            <div style="top: -.8em; right: 2em;" class="px-1 absolute bg-white text-right text-green-700 text-sm">
                                authoritative nameserver
                            </div>
                        </h3>
                        </h3>

                        <p>
                            In the previous experiments, we were looking at how
                            DNS names are cached. But you can always query the
                            source of truth for a domain: the <strong> authoritative nameserver </strong>.
                        </p>


                        <p>
                        <ol>
                            <li>

                                Create an A record for <domain-link :domain='domain'> </domain-link> at <code>example.com</code>, like this:
                                <img src="/images/cname-screenshot.png" class="block border  border-dashed border-green-700 mb-4 mt-2">
                            </li>
                            <li>
                                In your terminal, run
                                <pre>$ dig +trace {{currDomain()}}.messwithdns.com</pre> to get the authoritative nameserver. The answer should be
                                <pre>ns1.messwithdns.com.</pre>
                            </li>
                            <li>
                                Run:
                                <pre>$ dig @ns1.messwithdns.com {{currDomain()}}.messwithdns.com</pre>
                                to get the A record for your domain

                            </li>
                            <li>
                                Make some changes to your A record, run
                                <pre> dig @ns1.messwithdns.com {{currDomain()}}.messwithdns.com </pre> again, and notice the changes are always immediately reflected even if there's a very big TTL!
                            </li>
                        </ol>
                        </p>



                    </summary>
                </details>
                <details class="relative my-8 border border-green-700 p-6">
                    <summary>
                        <h3 class="font-bold text-xl text-left mb-8 my-8 inline">
                            3. Get a Let's Encrypt certificate
                            <div style="top: -.8em; right: 2em;" class="px-1 absolute bg-white text-right text-green-700 text-sm">
                                TXT records
                            </div>
                        </h3>
                        </h3>
                    </summary>
                </details>

                <details class="relative my-8 border border-green-700 p-6">
                    <summary>
                        <h3 class="font-bold text-xl text-left mb-8 my-8 inline">
                            4. Receive an email
                            <div style="top: -.8em; right: 2em;" class="px-1 absolute bg-white text-right text-green-700 text-sm">
                                MX records
                            </div>
                        </h3>
                    </summary>
                </details>
                <details class="relative my-8 border border-green-700 p-6">
                    <summary>
                        <h3 class="font-bold text-xl text-left mb-8 my-8 inline">
                            5. Send an email (and pass the SPF check)
                            <div style="top: -.8em; right: 2em;" class="px-1 absolute bg-white text-right text-green-700 text-sm">
                                TXT records (SPF)
                            </div>
                        </h3>
                    </summary>
                </details>
                <details class="relative my-8 border border-green-700 p-6">
                    <summary>
                        <h3 class="font-bold text-xl text-left mb-8 my-8 inline">
                            5. Set up Netlify
                            <div style="top: -.8em; right: 2em;" class="px-1 absolute bg-white text-right text-green-700 text-sm">
                                CNAME records
                            </div>
                        </h3>
                    </summary>
                </details>
            </div>
            <div v-else>
                <!-- option to open sidebar -->
                <div class="flex justify-center">
                    <button class="font-bold py-2 px-4 rounded" @click="sidebar = true">
                        Show experiments 🡆
                    </button>
                </div>
            </div>

        </div>
        <!-- end of experiments -->
        <div class="m-auto">
            <div class="m-auto w-full pt-16 px-8 mb-24">
                <div v-if="domain && domain != ''">
                    <h1 class="font-bold text-3xl text-center mb-8">
                        DNS records for {{ domain }}.messwithdns.com
                    </h1>

                    <h2 class="font-bold text-xl my-4"> Add a record </h2>

                    <new-record :domain='domain' class="pl-16"> </new-record>

                    <h2 class="font-bold text-xl my-8"> All DNS records </h2>
                    <div v-if="records && records.length > 0">
                        <table class="w-full">
                            <tr class="bg-gray-100 border border-gray-300">
                                <th class="text-left px-4 py-2">
                                    Type
                                </th>
                                <th class="text-left">
                                    Content
                                </th>
                                <th class="text-left">
                                    TTL
                                </th>
                                <th class="text-left">
                                    &nbsp;
                                </th>
                            </tr>
                            <tbody is="record" v-for="record in records" :key="record.id" :record="record" />
                        </table>
                    </div>
                    <div v-else>
                        <p class="text-center">
                            No records yet! You can add one!
                        </p>
                    </div>
                </div>
                <div v-else style="max-width: 500px" class="m-auto">
                    <h1 class="font-bold text-3xl text-center mb-8">
                        Welcome to mess with dns!
                    </h1>
                    <p class="my-8 text-xl">
                        This is a site where you can do weird DNS
                        experiments without any risk -- you
                        can use my domain to do them instead of
                        worrying about breaking your domain :)
                    </p>
                    <div class="flex justify-center">
                        <a id="randomSubdomain" class="no-underline bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg text-xl" :href="'/#' + randomSubdomain()">
                            Get a random subdomain
                        </a>
                    </div>
                    <!-- existing subdomain -->
                    <p class="text-center my-8 text-xl"> or go to an existing subdomain: </p>
                    <div class="flex justify-center">
                        <formulate-form @submit="setDomain" class="flex">
                            <formulate-input name="domain" type="text" :placeholder="randomSubdomain()" element-class="border border-green-700 rounded-lg p-1 h-full text-xl" required> </formulate-input>

                            <formulate-input type="submit" value="Go" class="ml-4 bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg text-xl"></formulate-input>
                        </formulate-form>
                    </div>

                </div>
            </div>
        </div>
    </div>
</body>

<script id="view-record" type="vue-component">
    <tbody>
        <tr class="border border-gray-200 cursor-pointer" @click="toggle()">
            <td class="px-4 py-2">
                {{ record.type }}
            </td>
            <td>
                {{ content() }}
            </td>
            <td>
                {{ record.ttl }}
            </td>
            <td class="text-right"> 
                <button class="edit hover:text-green-700 text-green-500 font-bold py-2 px-4 rounded">
                    Edit
                    <span v-if="clicked">
                        <svg style="transform: rotate(90deg);" fill="currentColor" class="inline w-4" aria-label="caret-right" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16">
                            <path d="M4.488 1.85l.854-.353 6.15 6.15v.707l-6.15 6.15-.854-.354V1.85z"></path>
                        </svg>
                    </span>
                    <span v-else>
                        <svg class="inline w-4" aria-label="caret-right" fill="currentColor" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16">
                            <path d="M4.488 1.85l.854-.353 6.15 6.15v.707l-6.15 6.15-.854-.354V1.85z"></path>
                        </svg>
                    </span>
                </button>
            </td>
        </tr>
        <tr class="border border-gray-200" v-if="clicked">
            <td colspan="4" class="pl-8">
                <formulate-form v-model="updated_record" class="mt-2" @submit="updateRecord">
                    <div class="flex">
                        <formulate-input class="ml-4 "
                            element-class="border border-black rounded-lg mt-2 p-1"
                            v-for="item in schemas[record.type]" 
                            :key="item.name" 
                            v-bind="item"></formulate-input>
                    </div>

                    <div class="flex text-right mt-4">
                        <button class="delete hover:bg-gray-400 mr-auto bg-gray-200 py-2 px-4 rounded" @click="confirmDelete()">
                            Delete
                        </button>
                        <button class="hover:bg-gray-400 bg-gray-200 py-2 px-4 rounded" @click="toggle()">
                            Cancel
                        </button>

                        <formulate-input 
                        element-class="hover:bg-green-700 ml-4 bg-green-500 text-white py-2 px-4 rounded"
                        type="submit" label="Save"></formulate-input>
                    </div>
            </formulate-form>
            </td>
        </tr>
    </tbody>
</script>

<script id="domain-link" type="vue-component">
    <code>
        <a v-if="domain && domain.length > 0" :href="'http://' + domain + '.messwithdns.com'"><span class="text-green-700">{{ domain }}</span>.messwithdns.com</a>
        <span v-else>
            <span class="text-green-700">your-domain</span>.messwithdns.com
        </span>
    </code>
</a>


</script>
<script id="new-record" type="vue-component">
    <formulate-form name='new-record' @submit="createRecord" v-model="data">
        <fieldset>
            <div class="flex flex-wrap">
                <formulate-input 
                class='mr-4 mt-4'
                element-class="border border-black rounded-lg mt-2 p-1" 
                name="type" label="Type" 
                v-model="type" type="select" 
                :options="options"></formulate-input>

                <formulate-input class="mr-4 mt-4"
                element-class="border border-black rounded-lg mt-2 p-1" 
                v-for="item in schemas[type]"
                :key="item.name" v-bind="item"></formulate-input>
            </div>
        </fieldset>
        <div style="color: red" v-if="error" class="pt-2">
            {{error}}
        </div>
        <div class="flex">
        <formulate-input 
        outer-class="mr-auto mt-4"
        element-class="hover:bg-green-700  bg-green-500 text-white py-2 px-4 rounded"
        type="submit" label="Create"></formulate-input>
        </div>
    </formulate-form>
</script>

<script src="bundle.js"></script>

</html>
